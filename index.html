<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>特リプTV｜パチスロ設定推測（画像 / テキスト対応・機種選択版）</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic","Meiryo",sans-serif;margin:24px;color:#111}
  h1{font-size:20px;margin:0 0 12px}
  .hint{background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12;padding:8px 10px;border-radius:8px;font-size:13px}
  .error{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:8px 10px;border-radius:8px;font-size:13px;margin-top:8px;display:none}
  .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:8px 10px;border-radius:8px;font-size:13px;margin-top:8px;display:none}
  .row{display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-top:12px}
  .btn{font-size:13px;padding:6px 10px;border-radius:6px;border:0;cursor:pointer}
  .btn.primary{background:#111;color:#fff}
  .btn.disabled{background:#d1d5db;color:#6b7280;cursor:not-allowed}
  img.thumb{height:112px;border:1px solid #e5e7eb;border-radius:8px}
  .card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin-top:12px}
  .card h3{margin:0 0 8px;font-size:14px}
  textarea{width:100%;height:160px;border:1px solid #e5e7eb;border-radius:8px;padding:8px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px}
  .grid{display:grid;grid-template-columns:1fr;gap:8px}
  @media(min-width:640px){.grid{grid-template-columns:1fr 1fr}}
  label span.key{width:140px;color:#374151;display:inline-block}
  input[type="number"]{border:1px solid #e5e7eb;border-radius:6px;padding:6px 8px;width:100%}
  .perg{font-size:11px;color:#6b7280;width:80px;text-align:right}
  .bar-wrap{width:100%;height:16px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar{height:16px;transition:width 300ms ease}
  .rowline{display:flex;align-items:center;justify-content:space-between;font-size:12px;margin-bottom:4px}
  .footer{margin-top:16px;font-size:12px;color:#6b7280}
  code{background:#f3f4f6;padding:0 4px;border-radius:4px}
  select#machine{min-width:260px;max-width:100%;white-space:nowrap;text-overflow:ellipsis;padding:6px 8px;border-radius:6px;border:1px solid #e5e7eb}
</style>
</head>
<body>
<h1>特リプTV｜パチスロ設定推測（データ画像 / テキスト対応・機種選択版）</h1>
<div class="hint">
  <strong>使い方:</strong> 先に「機種選択」。ユニメモのテキストをそのまま貼って「テキストから解析」。画像は「画像から解析」。<br>
  ※ 見出しと数値が離れて並ぶユニメモ形式に対応（見出し→後続の「◯回 / ◯G」を自動対応）。
</div>

<div id="err" class="error"></div>
<div id="ok" class="ok"></div>

<div class="row">
  <label for="machine"><strong>機種選択：</strong></label>
  <select id="machine">
    <option>新ハナビ</option>
    <option>バーサス・リヴァイズ</option>
    <option>アレックス・ブライト</option>
  </select>
</div>

<div class="row">
  <input id="file" type="file" accept="image/*" />
  <img id="thumb" class="thumb" style="display:none" alt="preview"/>
  <button id="btn-ocr" class="btn primary disabled" disabled type="button">画像から解析</button>
</div>

<div class="card">
  <div style="display:flex;align-items:center;justify-content:space-between;">
    <h3>テキスト（手動貼り付け）</h3>
    <button id="btn-parse" class="btn" style="background:#2563eb;color:#fff;" type="button">テキストから解析</button>
  </div>
  <textarea id="text" placeholder="ユニメモのテキストをそのまま貼り付け"></textarea>
</div>

<div class="card">
  <h3>抽出メトリクス（編集可）</h3>
  <div class="grid" id="metrics"></div>
</div>

<div class="card">
  <h3>推測比較（最大=赤、最小=水色）</h3>
  <div id="bars">必要な数値が揃うと比較グラフが表示されます。</div>
</div>

<div class="footer">
  ローカルOCR：<code>/tesseract/</code> に <code>worker.min.js</code>, <code>tesseract-core.wasm.js</code>, <code>lang-data/jpn.traineddata.gz</code>, <code>lang-data/eng.traineddata.gz</code> を配置。
</div>

<script>
/* ===== 期待値 (/G) ===== */
const PRESETS = {
  "新ハナビ": {
    keys:["bell","cherry","ice"],
    label:{games:"総G", bell:"風鈴", cherry:"チェリー", ice:"氷"},
    expect:{
      bell:[1/7.7,1/7.6,1/7.5,1/7.3],
      cherry:[1/16.4,1/15.3,1/16.1,1/15.6],
      ice:[1/51.2,1/51.8,1/48.2,1/49.3],
    },
    // OCR誤認識の別名も含める
    aliases:{
      games:[/総[ププ]レイ|総プレイ数|総ゲーム数?|総回転数?|総G数?|ゲーム数|回転数|合計回転数?/i],
      bell:[/風鈴|風鈴A|風鈴B/i],
      cherry:[/チェリー(?:A1|A2)?|チェリーB|ﾁｪﾘｰ/i],
      ice:[/氷|氷A|氷B/i],
    }
  },
  "バーサス・リヴァイズ": {
    keys:["bell","suika","cherry","vsg_hz"],
    label:{games:"総G", bell:"ベル", suika:"スイカ", cherry:"チェリー", vsg_hz:"VS GAME中はずれ"},
    expect:{
      bell:[1/7.2,1/7.1,1/6.9,1/6.8],
      suika:[1/55.5,1/53.4,1/54.4,1/52.3],
      cherry:[1/38.2,1/38.9,1/36.7,1/37.3],
      vsg_hz:[1/10.1,1/9.4,1/8.7,1/8.1],
    },
    aliases:{
      games:[/総[ププ]レイ|総プレイ(?:数|ダ)|総ゲーム数?|総回転数?|総G数?|ゲーム数|回転数/i], // 総プレイ"ダ"も拾う
      bell:[/ベル|ﾍﾞﾙ/i],
      suika:[/スイカ|スイ加|ﾊﾟｲﾝ|翠瓜/i], // OCR崩れ「スイ加」対応
      cherry:[/チェリー|チェリーム|ﾁｪﾘｰ/i], // 「チェリーム」対応
      vsg_hz:[/(?:V\s*S\s*G\s*A\s*M\s*E|VS\s*GAME|VSGAME).*?(?:はずれ|外れ|ﾊｽﾞﾚ)/i],
    }
  },
  "アレックス・ブライト": {
    keys:["hane","three","cherryA","cherryB","budou"],
    label:{games:"総G", hane:"羽", three:"3枚役", cherryA:"チェリーA", cherryB:"チェリーB", budou:"ブドウ"},
    expect:{
      hane:[1/13.4,1/13.0,1/12.6,1/12.2],
      three:[1/40.5,1/38.1,1/39.2,1/38.3],
      cherryA:[1/28.3,1/28.4,1/26.6,1/26.5],
      cherryB:[1/82.6,1/82.1,1/78.8,1/76.7],
      budou:[1/256.0,null,null,null],
    },
    aliases:{
      games:[/総[ププ]レイ|総プレイ数|総ゲーム数?|総回転数?|総G数?|ゲーム数|回転数/i],
      hane:[/羽(?:合算|回数)?/i],
      three:[/(?:3|３)\s*枚役/i],
      cherryA:[/チェリーA(?:合算|回数)?|チェリーA1|チェリーA2/i],
      cherryB:[/チェリーB(?:回数)?/i],
      budou:[/ブドウ|葡萄(?:合算|回数)?/i],
    }
  }
};

const state = { machine:"新ハナビ", imgUrl:null, ocrText:"", metrics:{} };

/* ===== ユーティリティ ===== */
function show(msg, ok=false){ const e=document.getElementById(ok?"ok":"err"), o=document.getElementById(ok?"err":"ok"); if(o){o.style.display="none";o.textContent="";} e.style.display=msg?"block":"none"; e.textContent=msg||""; }
/* 軽い正規化：全角→半角、空白統一、余計なスペース除去 */
function sanitize(s){
  return (s||"")
    .replace(/[０-９]/g,d=>String.fromCharCode(d.charCodeAt(0)-0xFEE0))
    .replace(/[，]/g,",").replace(/[．]/g,".").replace(/[　]/g," ")
    .replace(/[：:]\s*/g,":")
    .replace(/\s+\/\s+/g,"/")
    .replace(/[()（）]/g," ")
    .replace(/\s{2,}/g," ")
    .trim();
}
/* 数値抽出：G優先／回優先／分数(1/x)は除外 */
const RE_COUNT_G = /([0-9]{1,3}(?:,[0-9]{3})*|[0-9]+)\s*G\b/i;
const RE_COUNT_KAI = /([0-9]{1,3}(?:,[0-9]{3})*|[0-9]+)\s*回\b/;
const RE_FRACTION = /(^|[^0-9])1\s*\/\s*[0-9.]/;

/* 行→数値（指定タイプ） */
function pickCount(line, wantG=false){
  if(!line) return undefined;
  if(RE_FRACTION.test(line)) return undefined; // 1/◯◯ はスキップ
  const re = wantG ? RE_COUNT_G : RE_COUNT_KAI;
  const m = line.match(re);
  return m ? Number(m[1].replace(/,/g,"")) : undefined;
}

/* 別名から見出し行を見つけ、その後方にある count 行（◯回 or ◯G）を最大 N 行まで探索して取得 */
function findValueByHeader(lines, aliasRes, maxLookahead, wantG=false){
  for(let i=0;i<lines.length;i++){
    const ln = lines[i];
    if(aliasRes.some(re=>re.test(ln))){
      // 後ろ方向に広く探索（同じ行で拾えないケースに対応）
      for(let j=i; j<Math.min(lines.length, i+maxLookahead); j++){
        const v = pickCount(lines[j], wantG);
        if(v!=null) return v;
      }
    }
  }
  return undefined;
}

/* 最後の手段：1つのテキスト塊から名前→近接数値（20文字以内）を抜く */
function fallbackNearBy(text, aliasRes, wantG=false){
  const any = aliasRes.map(r=>r.source.replace(/^\^|\$$/g,"")).join("|");
  const m = new RegExp(`(?:${any}).{0,40}?([0-9]{1,3}(?:,[0-9]{3})*|[0-9]+)\\s*${wantG?"G":"回"}`,"i").exec(text);
  return m ? Number(m[1].replace(/,/g,"")) : undefined;
}

/* ===== 抽出 ===== */
function parseMetricsFromText(machine, textRaw){
  const t = sanitize(textRaw);
  const lines = t.split(/\r?\n/);
  const cfg = PRESETS[machine];
  const out = {};

  // 総G：見出し→後続から「◯G」を優先して取得（80行先まで）
  out.games = findValueByHeader(lines, cfg.aliases.games, 80, true);
  if(out.games==null){
    out.games = fallbackNearBy(t, cfg.aliases.games, true);
  }

  // 各小役：見出し→後続から「◯回」を優先（80行先まで）
  cfg.keys.forEach(k=>{
    let v = findValueByHeader(lines, cfg.aliases[k], 80, false);
    if(v==null) v = fallbackNearBy(t, cfg.aliases[k], false);
    out[k] = v;
  });

  return out;
}

/* ===== 推測計算 ===== */
function estimateAllSettings(machine, metrics){
  const cfg=PRESETS[machine];
  const g=metrics.games||0; if(!g) return [];
  const perG={}; cfg.keys.forEach(k=>{ if(metrics[k]!=null) perG[k]=(metrics[k]||0)/g; });
  const base=[1,2,5,6];
  const rows=base.map((s,i)=>{ let err=0,used=0;
    cfg.keys.forEach(k=>{
      const ex = cfg.expect[k]?.[i];
      if(perG[k]==null || ex==null || isNaN(ex)) return;
      err += Math.pow(perG[k]-ex,2); used++;
    });
    return {setting:s, score:used?1/(1+err):0, percent:0};
  });
  const sum = rows.reduce((a,b)=>a+b.score,0) || 1;
  rows.forEach(r=>r.percent = r.score/sum*100);
  return rows;
}

/* ===== UI ===== */
function barColor(p,max,min){
  if(p===max) return"rgba(239,68,68,0.85)";
  if(p===min) return"rgba(147,197,253,0.85)";
  const t=(p-min)/Math.max(1,max-min);
  const r=Math.round(147+(59-147)*t), g=Math.round(197+(130-197)*t), b=Math.round(253+(246-253)*t);
  return`rgba(${r},${g},${b},0.9)`;
}
function renderMetrics(){
  const wrap=document.getElementById("metrics"); wrap.innerHTML="";
  const cfg=PRESETS[state.machine]; const keys=["games",...cfg.keys];
  keys.forEach(k=>{
    const row=document.createElement("label"); row.style.display="flex"; row.style.alignItems="center"; row.style.gap="8px";
    const keySpan=document.createElement("span"); keySpan.className="key"; keySpan.textContent=cfg.label[k]||k; row.appendChild(keySpan);
    const input=document.createElement("input"); input.type="number"; input.inputMode="numeric";
    input.value = state.metrics[k] ?? "";
    input.oninput = (e)=>{ state.metrics[k] = e.target.value==="" ? undefined : Number(e.target.value); renderBars(); renderMetrics(); };
    row.appendChild(input);
    const tail=document.createElement("span"); tail.className="perg";
    if(k!=="games" && state.metrics.games){ tail.textContent="/G "+(((state.metrics[k]||0)/(state.metrics.games||1)).toFixed(4)); }
    row.appendChild(tail);
    wrap.appendChild(row);
  });
}
function renderBars(){
  const mount=document.getElementById("bars");
  const rows=estimateAllSettings(state.machine,state.metrics);
  if(!rows.length){ mount.textContent="必要な数値が揃うと比較グラフが表示されます。"; return; }
  const perc=rows.map(r=>r.percent), max=Math.max(...perc), min=Math.min(...perc);
  mount.innerHTML="";
  rows.forEach(r=>{
    const head=document.createElement("div"); head.className="rowline";
    head.innerHTML=`<span>${state.machine}｜設定${r.setting}</span><span>${r.percent.toFixed(2)}%</span>`;
    const barWrap=document.createElement("div"); barWrap.className="bar-wrap";
    const bar=document.createElement("div"); bar.className="bar";
    bar.style.width=Math.max(0,Math.min(100,r.percent))+"%";
    bar.style.background=barColor(r.percent,max,min);
    barWrap.appendChild(bar);
    mount.appendChild(head); mount.appendChild(barWrap);
  });
}

/* ===== 初期化・イベント ===== */
function setError(msg){ show(msg,false); }
function setOk(msg){ show(msg,true); }

function init(){
  state.machine=document.getElementById("machine").value;
  state.metrics={};
  renderMetrics(); renderBars();

  document.getElementById("machine").addEventListener("change",()=>{
    state.machine=document.getElementById("machine").value;
    state.metrics={}; setOk(""); setError("");
    renderMetrics(); renderBars();
  });

  const file=document.getElementById("file");
  const thumb=document.getElementById("thumb");
  const btnOcr=document.getElementById("btn-ocr");
  const btnParse=document.getElementById("btn-parse");
  const text=document.getElementById("text");

  file.addEventListener("change",(e)=>{
    setError(""); setOk("");
    const f=e.target.files && e.target.files[0];
    if(!f){ thumb.style.display="none"; state.imgUrl=null; btnOcr.classList.add("disabled"); btnOcr.disabled=true; return; }
    const url=URL.createObjectURL(f);
    state.imgUrl=url; thumb.src=url; thumb.style.display="inline-block";
    btnOcr.classList.remove("disabled"); btnOcr.disabled=false;
  });

  btnOcr.addEventListener("click", async ()=>{
    if(!state.imgUrl) return;
    setError(""); setOk("OCR解析中…");
    btnOcr.textContent="OCR解析中…"; btnOcr.disabled=true;
    try{
      const { createWorker } = window.Tesseract || {};
      if(!createWorker) throw new Error("Tesseract not loaded");
      const worker = await createWorker({
        workerPath: "/tesseract/worker.min.js",
        corePath: "/tesseract/tesseract-core.wasm.js",
        langPath: "/tesseract/lang-data", logger:()=>{}
      });
      await worker.loadLanguage("jpn+eng"); await worker.initialize("jpn+eng");
      const { data } = await worker.recognize(state.imgUrl); await worker.terminate();
      const t=(data&&data.text)||""; state.ocrText=t; text.value=t;
      state.metrics = parseMetricsFromText(state.machine,t);
      const hit = Object.values(state.metrics).filter(v=>v!=null).length;
      if(hit<=1) setError("抽出0件でした。『総プレイ数/総回転数/ゲーム数』と各小役名（風鈴/羽/ベル/チェリー/氷/ブドウ/VS GAME はずれ）を含めて貼ってください。");
      else setOk(`抽出 ${hit} 件`);
      renderMetrics(); renderBars();
    }catch(e){
      setError("OCRが使用できません。/tesseract/ を配置するか、テキスト貼付→『テキストから解析』をご利用ください。");
    }finally{
      btnOcr.textContent="画像から解析"; btnOcr.disabled=false;
    }
  });

  btnParse.addEventListener("click", ()=>{
    setError(""); setOk("");
    state.ocrText = text.value || "";
    state.metrics = parseMetricsFromText(state.machine, state.ocrText);
    const hit = Object.values(state.metrics).filter(v=>v!=null).length;
    if(hit<=1){ setError("抽出0件でした。ユニメモの『項目見出し』と、その後に並ぶ数値の塊を丸ごと貼ってください。"); }
    else { setOk(`抽出 ${hit} 件`); }
    renderMetrics(); renderBars();
  });
}

/* 任意：Tesseract ローダ（失敗してもOK） */
(function tryLoadTesseract(){ const s=document.createElement("script"); s.src="/tesseract/tesseract.min.js"; s.async=true; document.head.appendChild(s); })();

init();
</script>
</body>
</html>
