<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>設定判別（機種セレクター対応｜新ハナビ＆バーサス・リヴァイズ）03</title>
  <style>
    :root{--bg:#0b0f14;--card:#121822;--ink:#e7edf6;--muted:#9fb0c6;--accent:#5fd1ff;--good:#ff4d6d;--mid:#4ea8de;--low:#91e5f6;--warn:#ffd166;--ok:#06d6a0}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",Meiryo,sans-serif;}
    header{padding:16px 20px;border-bottom:1px solid #1e2633;background:#0f141d;position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:18px;letter-spacing:.02em}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    main{padding:20px;display:grid;gap:16px;grid-template-columns: 1.1fr .9fr}
    @media (max-width: 960px){main{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid #1b2431;border-radius:14px;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label.kv{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px}
    select,button,input[type="checkbox"],textarea{font:inherit}
    select,button{background:#0f1520;color:var(--ink);border:1px solid #243044;border-radius:10px;padding:8px 10px}
    button.primary{background:linear-gradient(180deg,#1d2a3a,#172233);border-color:#2a3c54}
    button.ghost{background:transparent;border-color:#2a3c54}
    button:active{transform:translateY(1px)}
    textarea#text{width:100%;min-height:180px;background:#0b111a;color:var(--ink);border:1px solid #223045;border-radius:10px;padding:12px}

    .bars{display:grid;gap:10px}
    .bar{display:grid;grid-template-columns: 140px 1fr 90px;gap:10px;align-items:center}
    .bar .name{color:var(--muted);font-size:13px}
    .bar .track{height:12px;background:#0b111a;border:1px solid #213045;border-radius:999px;overflow:hidden}
    .bar .fill{height:100%;background:linear-gradient(90deg,var(--low),var(--mid),var(--good));width:0%}
    .bar .val{font-variant-numeric:tabular-nums;text-align:right;color:#cdd8e8;font-size:13px}

    table{width:100%;border-collapse:collapse;border:1px solid #233046;border-radius:10px;overflow:hidden}
    th,td{border-bottom:1px solid #1e2a3b;padding:8px 10px;font-size:13px}
    th{background:#0f1520;text-align:left;color:#b7c6db}
    tr:last-child td{border-bottom:none}

    .note{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #28405a;border-radius:999px;font-size:12px;color:#a6c3de}
    .hint{font-size:12px;color:#a7bbd5}
    .right{margin-left:auto}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
  </style>
</head>
<body>
  <header>
    <h1>設定判別｜機種セレクター対応（新ハナビ／バーサス・リヴァイズ）</h1>
    <div class="sub">ユニメモ結果を貼って「テキストから解析」。偶奇示唆・確定系チェック対応、履歴保存付き。</div>
  </header>

  <main>
    <section class="card" style="grid-column:1/-1">
      <div class="row">
        <label class="kv">機種：
          <select id="machine">
            <option value="shin-hanabi">新ハナビ</option>
            <option value="versus-revise">バーサス・リヴァイズ</option>
          </select>
        </label>
        <!-- 新ハナビ -->
        <label class="kv"><input type="checkbox" id="peace"/> ピース出現（新ハナビ：1を除外）</label>
        <label class="kv"><input type="checkbox" id="yohaku-hazure"/> 予告音氷ハズレ（新ハナビ：1・2を除外）</label>
        <!-- バーサス -->
        <label class="kv"><input type="checkbox" id="end-red"/> END赤（バーサス：2以上）</label>
        <label class="kv"><input type="checkbox" id="rb-3x-miss"/> RB中3連Xハズレ（バーサス：5以上）</label>

        <button id="analyze" class="primary">テキストから解析</button>
        <button id="clear" class="ghost">入力をクリア</button>
        <span class="right hint">ユニメモの結果欄をそのまま貼り付け → 解析</span>
      </div>
      <textarea id="text" placeholder="例）総プレイ数 6,056G / ベル合算 1/7.2 / スイカ合算 1/55.5 / VS CHANCE中はずれ 1/4.9 ..."></textarea>
    </section>

    <section class="card">
      <h3 style="margin-top:0">尤度（設定推測％）</h3>
      <div id="likelihood"></div>
      <div class="note">有効観測が無い場合は表を出しません（全設定25%になる問題回避）。</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">抽出メトリクス</h3>
      <div class="bars" id="bars"></div>
    </section>

    <section class="card" style="grid-column:1/-1">
      <div class="row" style="margin-bottom:10px">
        <strong>履歴</strong>
        <span class="pill" id="hist-count">0 件</span>
        <span class="right"></span>
        <button id="exportCsv" class="ghost">CSVエクスポート</button>
        <button id="exportJson" class="ghost">JSONエクスポート</button>
      </div>
      <div class="note">
        ・解析ごとに端末内（localStorage）に保存 / 最大200件<br>
      </div>
      <table id="hist">
        <thead><tr><th>日時</th><th>機種</th><th>設定推測</th><th>要約</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
  /* ================= 機種ごとの設定レジストリ ================= */
  const MACHINES = {
    "shin-hanabi": {
      name: "新ハナビ",
      settings: [1,2,5,6],
      expect: { // 通常時 1/G
        bell:  [1/7.7,  1/7.6,  1/7.5,  1/7.3],
        cherry:[1/16.4, 1/15.3, 1/16.1, 1/15.6],
        ice:   [1/51.2, 1/51.8, 1/48.2, 1/49.3],
      },
      expectDenom: { // 1/◯
        bb_slant:  {1:11.0, 2:9.0, 5:11.0, 6:9.0},
        bb_rare:   {1:16384,2:16384,5:16384,6:655.4},
        rt_hc_miss:{1:6.0,  2:5.8,  5:5.3,  6:5.1},
        rt_hg_miss:{1:13.4, 2:12.4, 5:10.1, 6:9.5}
      },
      ranges: { // 分母
        bell:[4.5,10.5], cherry:[10,25], ice:[35,80],
        rt_hc:[4.6,6.6], rt_hg:[8.5,14.5]
      },
      weights: { bell:1.0, cherry:1.0, ice:0.7, rt_hc_miss:1.0, rt_hg_miss:1.0 },
      labelRegex: {
        total:/総プレイ数|総ゲーム数|総G|プレイ数|ゲーム数/i,
        bell:/風鈴\s*合算|ベル\s*合算/i,
        cherry:/チェリー\s*合算/i,
        ice:/氷\s*合算/i,
        rt_hc:/花火チャレンジ中はずれ/i,
        rt_hg:/花火GAME中はずれ/i
      },
      disableSettingsByFlags: (flags)=>({ 1: !!flags.peace || !!flags.yohakuHazure, 2: !!flags.yohakuHazure })
    },

    "versus-revise": {
      name: "バーサス・リヴァイズ",
      settings: [1,2,5,6],
      expect: { // 通常時 1/G（スイカ=ice）
        bell:  [1/7.2, 1/7.1, 1/6.9, 1/6.8],
        cherry:[1/38.2,1/38.9,1/36.7,1/37.3],
        ice:   [1/55.5,1/53.4,1/54.4,1/52.3]
      },
      expectDenom: { // 1/◯
        rt_hc_miss:{1:5.0, 2:4.9, 5:4.6, 6:4.5},  // VS CHANCE はずれ
        rt_hg_miss:{1:10.1,2:9.4, 5:8.7, 6:8.1}, // VS GAME はずれ
        // 参考（偶奇示唆用に観測を受け取る器。未入力でもOK）
        bb_cb:      {1:11.1,2:8.9, 5:11.1,6:8.9},
        bb_cb_miss: {1:256.0,2:128.0,5:256.0,6:128.0}
      },
      ranges: {
        bell:[6.2,9.2], cherry:[30,50], ice:[45,80],
        rt_hc:[4.2,5.6], rt_hg:[7.5,10.8],
        bb_cb:[7.5,13.0], bb_cb_miss:[80,350]
      },
      weights: { bell:0.9, cherry:0.5, ice:0.8, rt_hc_miss:1.1, rt_hg_miss:1.6, bb_cb:1.2, bb_cb_miss:1.6 },
      labelRegex: {
        total:/総プレイ数|総ゲーム数|総G|プレイ数|ゲーム数/i,
        bell:/ベル\s*合算/i,
        cherry:/チェリー\s*合算/i,
        ice:/スイカ\s*合算/i,
        rt_hc:/VS?\s*チャレンジ中はずれ|VS\s*CHANCE中はずれ/i,
        rt_hg:/VS?\s*GAME中はずれ/i,
        bb_cb:/チェリー\s*\+\s*ベル揃い|チェリー\+ベル揃い/i,
        bb_cb_miss:/チェリー\s*\+\s*ベルはずれ|チェリー\+ベルはずれ/i
      },
      disableSettingsByFlags: (flags)=>({ 1: !!flags.endRed || !!flags.rb3xMiss, 2: !!flags.rb3xMiss })
    }
  };

  // ============== 共通 State / Utils ==============
  const state = { metrics:{}, flags:{ peace:false, yohakuHazure:false, endRed:false, rb3xMiss:false } };
  const $ = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const currentMachine = ()=> MACHINES[$('#machine').value || 'shin-hanabi'];

  // ---- サニタイズ & 行割れ結合（OCR耐性）
  function sanitize(s){
    return (s||"")
      .replace(/[０-９]/g, d=>String.fromCharCode(d.charCodeAt(0)-0xFEE0))
      .replace(/[，]/g, ",").replace(/[．]/g, ".")
      .replace(/[：:]\s*/g, ": ")
      .replace(/[　]/g, " ")
      .replace(/[／]/g, "/")
      .replace(/\s+\/\s+/g, "/")
      .replace(/\s{2,}/g, " ")
      .trim();
  }
  function coalesceHeadingBreaks(t){
    return t
      .replace(/(風鈴|ベル)\s*\n\s*合算/g, "$1合算")
      .replace(/氷\s*\n\s*合算/g, "氷合算")
      .replace(/スイカ\s*\n\s*合算/g, "スイカ合算")
      .replace(/チェリー\s*\n\s*合算/g, "チェリー合算")
      .replace(/花火チャレンジ中\s*\n\s*(?:はずれ|ハズレ)/g, "花火チャレンジ中はずれ")
      .replace(/花火GAME中\s*\n\s*(?:はずれ|ハズレ)/g, "花火GAME中はずれ")
      .replace(/VS\s*CHANCE中\s*\n\s*(?:はずれ|ハズレ)/i, "VS CHANCE中はずれ")
      .replace(/VS\s*GAME中\s*\n\s*(?:はずれ|ハズレ)/i, "VS GAME中はずれ");
  }

  // ====== 解析：ユニメモテキストから数値を抽出 ======
  function parseMetricsFromText(txt){
    const M = currentMachine();
    const R = M.labelRegex;
    const t = coalesceHeadingBreaks(sanitize(txt));
    const metrics = {};

    // 総G（見つかった最大の ◯◯G）
    const g = [...t.matchAll(/(\d{1,3}(?:,\d{3})*|\d+)\s*G/gi)]
      .map(m=>parseInt(m[1].replace(/,/g,''),10));
    metrics.totalG = g.length? Math.max(...g) : 0;

    // 近傍で 1/◯ または 「◯回」→分母
    const pickRatioNear = (re)=>{
      if(!re) return null;
      const m = t.match(re);
      if(!m) return null;
      const tail = t.slice(m.index, m.index+100);
      const m1 = tail.match(/1\s*\/\s*([0-9]+(?:\.[0-9]+)?)/);
      if(m1) return parseFloat(m1[1]);
      const m2 = tail.match(/([0-9]+)\s*回/);
      if(m2 && metrics.totalG>0){
        const cnt=parseFloat(m2[1]); return cnt? (metrics.totalG/cnt) : null;
      }
      return null;
    };

    metrics.bell   = pickRatioNear(R.bell);
    metrics.cherry = pickRatioNear(R.cherry);
    metrics.ice    = pickRatioNear(R.ice);
    metrics.rt_hc  = pickRatioNear(R.rt_hc);
    metrics.rt_hg  = pickRatioNear(R.rt_hg);

    // バーサスの偶奇示唆（任意）：BB複合
    metrics.bb_cb       = pickRatioNear(R.bb_cb);
    metrics.bb_cb_miss  = pickRatioNear(R.bb_cb_miss);

    return metrics;
  }

  // ====== 推測：簡易尤度（観測が無ければ出力しない） ======
  function estimateLikelihood(metrics){
    const M = currentMachine();
    const settings = M.settings;
    const weights = M.weights||{};
    const exp = M.expect||{};
    const denom = M.expectDenom||{};
    const disabled = (M.disableSettingsByFlags||(()=>({}))) (state.flags) || {};

    const asRate = v=> (v && v>0) ? (1/parseFloat(v)) : null;
    const obs = {
      bell:   asRate(metrics.bell),
      cherry: asRate(metrics.cherry),
      ice:    asRate(metrics.ice),
      rt_hc_miss: asRate(metrics.rt_hc),
      rt_hg_miss: asRate(metrics.rt_hg),
      bb_cb:      asRate(metrics.bb_cb),
      bb_cb_miss: asRate(metrics.bb_cb_miss)
    };

    const scoreFor = (expected, observed)=>{
      if(expected==null || observed==null) return null;
      const rel = Math.abs(observed-expected)/Math.max(expected,1e-9);
      return Math.exp(- (rel*rel) / (2*0.12*0.12));
    };

    let anyUsed = false;
    const raw = settings.map((s)=>{
      if(disabled[s]) return {setting:s, score:0, used:false};
      const idx = [1,2,5,6].indexOf(s);
      let sum=0, w=0;

      if(exp.bell   && obs.bell   !=null){ sum += (weights.bell||1)   * scoreFor(exp.bell[idx],   obs.bell  ); w += (weights.bell||1); }
      if(exp.cherry && obs.cherry !=null){ sum += (weights.cherry||1) * scoreFor(exp.cherry[idx], obs.cherry); w += (weights.cherry||1); }
      if(exp.ice    && obs.ice    !=null){ sum += (weights.ice||1)    * scoreFor(exp.ice[idx],    obs.ice   ); w += (weights.ice||1); }

      if(denom.rt_hc_miss && obs.rt_hc_miss!=null){ sum += (weights.rt_hc_miss||1) * scoreFor(1/denom.rt_hc_miss[s], obs.rt_hc_miss); w += (weights.rt_hc_miss||1); }
      if(denom.rt_hg_miss && obs.rt_hg_miss!=null){ sum += (weights.rt_hg_miss||1) * scoreFor(1/denom.rt_hg_miss[s], obs.rt_hg_miss); w += (weights.rt_hg_miss||1); }

      // バーサスの偶奇示唆（任意入力）
      if(denom.bb_cb && obs.bb_cb!=null){ sum += (weights.bb_cb||0) * scoreFor(1/denom.bb_cb[s], obs.bb_cb); w += (weights.bb_cb||0); }
      if(denom.bb_cb_miss && obs.bb_cb_miss!=null){ sum += (weights.bb_cb_miss||0) * scoreFor(1/denom.bb_cb_miss[s], obs.bb_cb_miss); w += (weights.bb_cb_miss||0); }

      const used = w>0; anyUsed = anyUsed || used;
      return {setting:s, score: used? (sum/w) : 0, used};
    });

    if(!anyUsed){ return []; } // 観測ゼロ → 出力しない

    // 正規化
    const total = raw.reduce((a,b)=>a + Math.max(0,b.score), 0) || 1;
    return raw.map(r=>({ setting:r.setting, p: Math.max(0,r.score)/total }));
  }

  // ====== UI：バー描画 ======
  function renderBars(){
    const M = currentMachine();
    const R = M.ranges || {};
    const m = state.metrics || {};
    const root = $('#bars');
    root.innerHTML = '';

    const defs = (M.name.includes('ハナビ'))
      ? [
          {key:'bell',   label:'風鈴（1/◯）', range:R.bell},
          {key:'cherry', label:'チェリー（1/◯）', range:R.cherry},
          {key:'ice',    label:'氷（1/◯）', range:R.ice},
          {key:'rt_hc',  label:'HC はずれ（1/◯）', range:R.rt_hc},
          {key:'rt_hg',  label:'HG はずれ（1/◯）', range:R.rt_hg},
        ]
      : [
          {key:'bell',   label:'ベル合算（1/◯）', range:R.bell},
          {key:'ice',    label:'スイカ合算（1/◯）', range:R.ice},
          {key:'cherry', label:'チェリー合算（1/◯）', range:R.cherry},
          {key:'rt_hc',  label:'VS CHANCE はずれ（1/◯）', range:R.rt_hc},
          {key:'rt_hg',  label:'VS GAME はずれ（1/◯）', range:R.rt_hg},
          {key:'bb_cb',  label:'BB 複合（チェリー+ベル揃い）（1/◯）', range:R.bb_cb},
          {key:'bb_cb_miss',label:'BB 複合はずれ（1/◯）', range:R.bb_cb_miss},
        ];

    defs.forEach(d=>{
      const val = m[d.key];
      const [lo,hi] = d.range || [0,1];
      const denom = Number(val||0);
      const pct = (denom && lo && hi) ? (100 * (1 - (Math.min(Math.max(denom,lo),hi)-lo)/(hi-lo))) : 0; // 分母が小さいほど良い
      const row = document.createElement('div'); row.className='bar';
      row.innerHTML = `<div class="name">${d.label}</div>
        <div class="track"><div class="fill" style="width:${pct.toFixed(1)}%"></div></div>
        <div class="val">${denom?('1/'+denom.toFixed(1)):'—'}</div>`;
      root.appendChild(row);
    });
  }

  // ====== UI：尤度表描画 ======
  function renderLikelihood(save=true){
    const probs = estimateLikelihood(state.metrics||{});
    const root = $('#likelihood');
    root.innerHTML = '';

    if(!probs.length){
      const p = document.createElement('p');
      p.className = 'note';
      p.textContent = '比較に必要な数値が見つかりません（総Gと 合算/RTはずれ 等を貼り付けてください）';
      root.appendChild(p);
      return;
    }
    const sorted = [...probs].sort((a,b)=>b.p-a.p);
    const table = document.createElement('table');
    table.innerHTML = '<thead><tr><th>設定</th><th>推測％</th></tr></thead><tbody></tbody>';
    sorted.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.setting}</td><td>${(r.p*100).toFixed(1)}%</td>`;
      table.querySelector('tbody').appendChild(tr);
    });
    root.appendChild(table);

    if(save){ saveHistory(sorted); }
  }

  // ====== 履歴 ======
  const LS_KEY = 'tokuripu_history_v3';
  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(_){ return []; } }
  function saveHistory(sorted){
    const hist = loadHistory();
    const top = sorted[0];
    const h = {
      at: new Date().toISOString(),
      machine: currentMachine().name,
      top: { setting: top?.setting ?? null, p: top? Number((top.p*100).toFixed(1)) : null },
      summary: summarizeMetrics(state.metrics||{}),
      raw: state.metrics
    };
    hist.unshift(h);
    localStorage.setItem(LS_KEY, JSON.stringify(hist.slice(0,200)));
    renderHistory();
  }
  function summarizeMetrics(m){
    const f = (x)=> x? ('1/'+Number(x).toFixed(1)) : '—';
    return `ベル:${f(m.bell)} / スイカ(氷):${f(m.ice)} / CH:${f(m.cherry)} / HC:${f(m.rt_hc)} / HG:${f(m.rt_hg)}`;
  }
  function renderHistory(){
    const hist = loadHistory();
    $('#hist-count').textContent = `${hist.length} 件`;
    const tbody = $('#hist tbody'); tbody.innerHTML = '';
    hist.forEach(h=>{
      const d = new Date(h.at);
      const dt = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${dt}</td><td>${h.machine}</td><td>設定${h.top.setting??'—'}（${h.top.p??'—'}%）</td><td>${h.summary}</td>`;
      tbody.appendChild(tr);
    });
  }
  function exportCSV(){
    const hist = loadHistory();
    const head = ['日時','機種','最有力設定','推測%','ベル(1/◯)','スイカ/氷(1/◯)','チェリー(1/◯)','HC(1/◯)','HG(1/◯)'];
    const rows = hist.map(h=>{
      const m = h.raw||{}; const f = v=> v?Number(v).toFixed(1):'';
      return [h.at,h.machine,h.top?.setting??'',h.top?.p??'', f(m.bell),f(m.ice),f(m.cherry),f(m.rt_hc),f(m.rt_hg)];
    });
    const csv = [head, ...rows].map(r=> r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    downloadText('history.csv', csv);
  }
  function exportJSON(){ const hist = loadHistory(); downloadText('history.json', JSON.stringify(hist,null,2)); }
  function downloadText(name, txt){ const blob = new Blob([txt], {type:'text/plain;charset=utf-8'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href); }

  // ====== イベント配線 ======
  $('#analyze').addEventListener('click', ()=>{
    state.flags.peace = $('#peace').checked;
    state.flags.yohakuHazure = $('#yohaku-hazure').checked;
    state.flags.endRed = $('#end-red').checked;
    state.flags.rb3xMiss = $('#rb-3x-miss').checked;

    state.metrics = parseMetricsFromText($('#text').value||'');

    // バーサスの表記ゆれ対策（もし "氷" と書かれていたら ice に入るのでOK。逆に "スイカ" が未検出なら氷を流用）
    if($('#machine').value==='versus-revise' && !state.metrics.ice){
      const alt = ($('#text').value||'').match(/氷\s*合算/i);
      if(alt){ state.metrics.ice = state.metrics.ice || null; } // 何もしない（氷→iceで拾える構成）
    }

    renderBars(); renderLikelihood(true);
  });
  $('#clear').addEventListener('click', ()=>{ $('#text').value=''; });
  $('#machine').addEventListener('change', ()=>{
    state.metrics = parseMetricsFromText($('#text').value||'');
    renderBars(); renderLikelihood(false);
  });
  $('#exportCsv').addEventListener('click', exportCSV);
  $('#exportJson').addEventListener('click', exportJSON);

  // 初期化
  renderHistory();
  </script>
</body>
</html>
