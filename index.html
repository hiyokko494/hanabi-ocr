<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>設定判別（機種セレクター対応｜新ハナビ＆バーサス・リヴァイズ）</title>
  <style>
    :root{--bg:#0b0f14;--card:#121822;--ink:#e7edf6;--muted:#9fb0c6;--accent:#5fd1ff;--good:#ff4d6d;--mid:#4ea8de;--low:#91e5f6;--warn:#ffd166;--ok:#06d6a0}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",Meiryo,sans-serif;}
    header{padding:16px 20px;border-bottom:1px solid #1e2633;background:#0f141d;position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:18px;letter-spacing:.02em}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    main{padding:20px;display:grid;gap:16px;grid-template-columns: 1.1fr .9fr}
    @media (max-width: 960px){main{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid #1b2431;border-radius:14px;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label.kv{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px}
    select,button,input[type="checkbox"],textarea{font:inherit}
    select,button{background:#0f1520;color:var(--ink);border:1px solid #243044;border-radius:10px;padding:8px 10px}
    button.primary{background:linear-gradient(180deg,#1d2a3a,#172233);border-color:#2a3c54}
    button.ghost{background:transparent;border-color:#2a3c54}
    button:active{transform:translateY(1px)}
    textarea#text{width:100%;min-height:180px;background:#0b111a;color:#e7edf6;border:1px solid #223045;border-radius:10px;padding:12px}

    .bars{display:grid;gap:10px}
    .bar{display:grid;grid-template-columns: 150px 1fr 90px;gap:10px;align-items:center}
    .bar .name{color:var(--muted);font-size:13px}
    .bar .track{height:12px;background:#0b111a;border:1px solid #213045;border-radius:999px;overflow:hidden}
    .bar .fill{height:100%;background:linear-gradient(90deg,var(--low),var(--mid),var(--good));width:0%}
    .bar .val{font-variant-numeric:tabular-nums;text-align:right;color:#cdd8e8;font-size:13px}

    table{width:100%;border-collapse:collapse;border:1px solid #233046;border-radius:10px;overflow:hidden}
    th,td{border-bottom:1px solid #1e2a3b;padding:8px 10px;font-size:13px}
    th{background:#0f1520;text-align:left;color:#b7c6db}
    tr:last-child td{border-bottom:none}

    .note{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #28405a;border-radius:999px;font-size:12px;color:#a6c3de}
    .hint{font-size:12px;color:#a7bbd5}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <header>
    <h1>設定判別｜機種セレクター対応（新ハナビ／バーサス・リヴァイズ）</h1>
    <div class="sub">ユニメモのテキストをそのまま貼り付け → 解析。確定系チェックにも対応。</div>
  </header>

  <main>
    <section class="card" style="grid-column:1/-1">
      <div class="row">
        <label class="kv">機種：
          <select id="machine">
            <option value="shin-hanabi">新ハナビ</option>
            <option value="versus-revise">バーサス・リヴァイズ</option>
          </select>
        </label>

        <!-- 新ハナビの確定系 -->
        <label class="kv"><input type="checkbox" id="peace"/> ピース出現（1除外）</label>
        <label class="kv"><input type="checkbox" id="yohaku-hazure"/> 予告音氷ハズレ（1・2除外）</label>

        <!-- バーサスの確定系 -->
        <label class="kv"><input type="checkbox" id="end-red"/> RB終了画面 END赤（2以上）</label>
        <label class="kv"><input type="checkbox" id="rb-3x-miss"/> RB中3連Xハズレ（5以上）</label>

        <button id="analyze" class="primary">テキストから解析</button>
        <button id="clear" class="ghost">入力をクリア</button>
        <span class="right hint">例：ベル合算 1/◯、スイカ合算 1/◯、VS GAME中はずれ 1/◯、BB中 チェリー＋ベル揃い 1/◯ …</span>
      </div>
      <textarea id="text" placeholder="ユニメモの結果テキストをコピペしてください"></textarea>
    </section>

    <section class="card">
      <h3 style="margin-top:0">尤度（設定推測％）</h3>
      <div id="likelihood"></div>
      <div class="note">※ 有効な観測が無い場合は注意文のみを表示（均等25％は出しません）。</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">抽出メトリクス</h3>
      <div class="bars" id="bars"></div>
    </section>

    <section class="card" style="grid-column:1/-1">
      <div class="row" style="margin-bottom:10px">
        <strong>履歴</strong>
        <span class="pill" id="hist-count">0 件</span>
        <span class="right"></span>
        <button id="exportCsv" class="ghost">CSVエクスポート</button>
        <button id="exportJson" class="ghost">JSONエクスポート</button>
      </div>
      <table id="hist">
        <thead><tr><th>日時</th><th>機種</th><th>設定推測</th><th>要約</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
  /* ================= 機種ごとの設定レジストリ ================= */
  const MACHINES = {
    "shin-hanabi": {
      name: "新ハナビ",
      settings: [1,2,5,6],
      expect: {                // 通常時 推定 1/G
        bell:  [1/7.7,  1/7.6,  1/7.5,  1/7.3],
        cherry:[1/16.4, 1/15.3, 1/16.1, 1/15.6],
        ice:   [1/51.2, 1/51.8, 1/48.2, 1/49.3],
      },
      expectDenom: {           // 1/◯ の分母
        bb_slant:  {1:11.0, 2:9.0, 5:11.0, 6:9.0},
        bb_rare:   {1:16384,2:16384,5:16384,6:655.4},
        rt_hc_miss:{1:6.0,  2:5.8,  5:5.3,  6:5.1},
        rt_hg_miss:{1:13.4, 2:12.4, 5:10.1, 6:9.5}
      },
      ranges: { bell:[4.5,10.5], cherry:[10,25], ice:[35,80],
                bb_slant:[7,13], bb_rare:[400,30000], rt_hc:[4.6,6.6], rt_hg:[8.5,14.5] },
      weights: { bell:1.0, cherry:1.0, ice:0.7, bb_slant:1.1, bb_rare:2.2, rt_hc_miss:1.0, rt_hg_miss:1.0 },
      labelRegex: {
        total:/総プレイ数|総ゲーム数|総G|プレイ数|ゲーム数/i,
        bell:/風鈴\s*合算|ベル\s*合算/i,
        cherry:/チェリー\s*合算/i,
        ice:/氷\s*合算/i,
        bb_slant:/(風斜め揃い|斜め風鈴|風鈴B)/i,
        bb_rare:/(レア役|バラケ目)/i,
        rt_hc:/花火チャレンジ中はずれ/i,
        rt_hg:/花火GAME中はずれ/i
      },
      disableSettingsByFlags: (flags)=>({
        1: !!flags.peace || !!flags.yohakuHazure,
        2: !!flags.yohakuHazure
      })
    },

    "versus-revise": {
      name: "バーサス・リヴァイズ",
      settings: [1,2,5,6],
      // 通常時（1/G）＝ユーザー提示の最新値ベース
      expect: {
        bell:  [1/7.2, 1/7.1, 1/6.9, 1/6.8],      // ベル合算
        cherry:[1/38.2,1/38.9,1/36.7,1/37.3],     // チェリー合算
        ice:   [1/55.5,1/53.4,1/54.4,1/52.3],     // = スイカ合算（同義で扱う）
      },
      expectDenom: {
        rt_hc_miss:{1:5.0,  2:4.9, 5:4.6, 6:4.5}, // VS CHANCE はずれ
        rt_hg_miss:{1:10.1, 2:9.4, 5:8.7, 6:8.1}, // VS GAME はずれ
        // （BB中の偶奇要素は必要なら後日拡張）
      },
      ranges: {
        bell:[6.2,9.2], cherry:[30,50], ice:[45,80],
        rt_hc:[4.2,5.6], rt_hg:[7.5,10.8]
      },
      weights: { bell:0.9, cherry:0.5, ice:0.8, rt_hc_miss:1.1, rt_hg_miss:1.6 },
      labelRegex: {
        total:/総プレイ数|総ゲーム数|総G|プレイ数|ゲーム数/i,
        bell:/ベル\s*合算/i,
        cherry:/チェリー\s*合算/i,
        ice:/スイカ\s*合算/i,                   // スイカ＝ice として扱う
        rt_hc:/VS?\s*チャレンジ中はずれ|VS\s*CHANCE中はずれ/i,
        rt_hg:/VS?\s*GAME中はずれ/i
      },
      // 確定系：END赤（2以上）/RB3連Xハズレ（5以上）
      disableSettingsByFlags: (flags)=>({
        1: !!flags.endRed || !!flags.rb3xMiss,
        2: !!flags.rb3xMiss
      })
    }
  };

  // ====== 共通 State / Utils ======
  const state = { metrics:{}, flags:{ peace:false, yohakuHazure:false, endRed:false, rb3xMiss:false } };
  const $ = (s,root=document)=>root.querySelector(s);

  const currentMachine = ()=> MACHINES[$('#machine').value || 'shin-hanabi'];

  // サニタイズ & 見出し割れの結合
  function sanitize(s){
    return (s||"")
      .replace(/[０-９]/g, d=>String.fromCharCode(d.charCodeAt(0)-0xFEE0))
      .replace(/[，]/g, ",").replace(/[．]/g, ".")
      .replace(/[：:]\s*/g, ": ")
      .replace(/[　]/g, " ")
      .replace(/[／]/g, "/")
      .replace(/\s+\/\s+/g, "/")
      .replace(/\s{2,}/g, " ")
      .trim();
  }
  function coalesceHeadings(t){
    return t
      .replace(/(風鈴|ベル)\s*\n\s*合算/g, "$1合算")
      .replace(/(氷|スイカ)\s*\n\s*合算/g, (m,p)=> (p==="氷"?"氷合算":"スイカ合算"))
      .replace(/チェリー\s*\n\s*合算/g, "チェリー合算")
      .replace(/(花火|VS)\s*(?:チャレンジ|CHANCE)中\s*\n\s*(?:はずれ|ハズレ)/g, s=>s.replace(/\n/g,""))
      .replace(/GAME中\s*\n\s*(?:はずれ|ハズレ)/g, s=>s.replace(/\n/g,""));
  }

  // ====== 解析：ユニメモテキストから数値を抽出 ======
  function parseMetricsFromText(txtRaw){
    const M = currentMachine();
    const R = M.labelRegex;
    const metrics = {};

    let txt = coalesceHeadings(sanitize(txtRaw));

    // 総G
    const guessTotalGames = (t)=>{
      const m = t.match(/(総プレイ数|総ゲーム数|総G|プレイ数|ゲーム数)[^\d]*(\d{1,3}(?:,\d{3})*|\d+)\s*G/i);
      return m ? parseInt(m[2].replace(/,/g,''),10) : 0;
    };
    const totalG = guessTotalGames(txt);
    metrics.totalG = totalG||0;

    // ラベル近傍の 1/◯ or 「◯回」から分母を取る
    const pickRatioNear = (regex)=>{
      if(!regex) return null;
      const m = txt.match(regex);
      if(!m) return null;
      const tail = txt.slice(m.index).slice(0, 100);
      const m1 = tail.match(/1\s*\/\s*(\d+\.?\d*)/);
      if(m1) return parseFloat(m1[1]);
      const m2 = tail.match(/(\d+\.?\d*)\s*回/);
      if(m2 && totalG>0){
        const cnt = parseFloat(m2[1]);
        if(cnt>0) return totalG/cnt;
      }
      return null;
    };

    // 通常時
    metrics.bell   = pickRatioNear(R.bell);
    metrics.cherry = pickRatioNear(R.cherry);
    metrics.ice    = pickRatioNear(R.ice);   // 新ハナビ=氷、バーサス=スイカ

    // RT/BB系（必要最小限）
    metrics.rt_hc  = pickRatioNear(R.rt_hc);
    metrics.rt_hg  = pickRatioNear(R.rt_hg);

    // バーサスの場合、ice/suikaを同義で保持（今後の拡張用）
    if($('#machine').value==='versus-revise'){
      metrics.suika = metrics.ice;
    }

    return metrics;
  }

  // ====== 推測：簡易尤度計算（有効観測ゼロなら空配列を返す） ======
  function estimateLikelihood(metrics){
    const M = currentMachine();
    const settings = M.settings;
    const weights = M.weights;
    const exp = M.expect;
    const denom = M.expectDenom;

    const FLAGS_DISABLE = M.disableSettingsByFlags(state.flags) || {};

    const asRate = v=> (v && v>0) ? (1/parseFloat(v)) : null;
    const obs = {
      bell:   asRate(metrics.bell),
      cherry: asRate(metrics.cherry),
      ice:    asRate(metrics.ice),
      rt_hc_miss: metrics.rt_hc ? (1/metrics.rt_hc) : null,
      rt_hg_miss: metrics.rt_hg ? (1/metrics.rt_hg) : null,
    };

    const scoreFor = (expected, observed)=>{
      if(expected==null || observed==null) return null;
      const rel = Math.abs(observed-expected)/Math.max(expected,1e-9);
      return Math.exp(- (rel*rel) / (2*0.12*0.12));
    };

    // 有効観測が一つも無ければ空配列
    const anyObs = [obs.bell,obs.cherry,obs.ice,obs.rt_hc_miss,obs.rt_hg_miss].some(v=>v!=null);
    if(!anyObs) return [];

    const raw = settings.map((s)=>{
      if(FLAGS_DISABLE[s]) return {setting:s, score:0};
      const idx = [1,2,5,6].indexOf(s);
      let sum=0, w=0;

      if(exp.bell && obs.bell!=null){ sum += (weights.bell||1)*scoreFor(exp.bell[idx], obs.bell); w += (weights.bell||1); }
      if(exp.cherry && obs.cherry!=null){ sum += (weights.cherry||1)*scoreFor(exp.cherry[idx], obs.cherry); w += (weights.cherry||1); }
      if(exp.ice && obs.ice!=null){ sum += (weights.ice||1)*scoreFor(exp.ice[idx], obs.ice); w += (weights.ice||1); }

      if(denom.rt_hc_miss && obs.rt_hc_miss!=null){ sum += (weights.rt_hc_miss||1)*scoreFor(1/denom.rt_hc_miss[s], obs.rt_hc_miss); w+=(weights.rt_hc_miss||1); }
      if(denom.rt_hg_miss && obs.rt_hg_miss!=null){ sum += (weights.rt_hg_miss||1)*scoreFor(1/denom.rt_hg_miss[s], obs.rt_hg_miss); w+=(weights.rt_hg_miss||1); }

      const used = w>0;
      return {setting:s, score: used? (sum/w) : 0};
    });

    // 全て0なら空配列
    if(raw.every(r=>r.score===0)) return [];

    const total = raw.reduce((a,b)=>a+b.score,0) || 1;
    return raw.map(r=> ({setting:r.setting, p: r.score/total}));
  }

  // ====== UI：バー描画（機種ごとに項目/ラベルを切替） ======
  function renderBars(){
    const M = currentMachine();
    const R = M.ranges;
    const m = state.metrics || {};
    const root = $('#bars');
    root.innerHTML = '';

    let defs;
    if($('#machine').value==='shin-hanabi'){
      defs = [
        {key:'bell',    label:'風鈴（1/◯）', range:R.bell},
        {key:'cherry',  label:'チェリー（1/◯）', range:R.cherry},
        {key:'ice',     label:'氷（1/◯）', range:R.ice},
        {key:'rt_hc',   label:'HC はずれ（1/◯）', range:R.rt_hc},
        {key:'rt_hg',   label:'HG はずれ（1/◯）', range:R.rt_hg},
      ];
    }else{
      defs = [
        {key:'bell',    label:'ベル合算（1/◯）', range:R.bell},
        {key:'ice',     label:'スイカ合算（1/◯）', range:R.ice},
        {key:'cherry',  label:'チェリー合算（1/◯）', range:R.cherry},
        {key:'rt_hc',   label:'VS CHANCE はずれ（1/◯）', range:R.rt_hc},
        {key:'rt_hg',   label:'VS GAME はずれ（1/◯）', range:R.rt_hg},
      ];
    }

    defs.forEach(d=>{
      const denom = Number(m[d.key]||0);
      const [lo,hi] = d.range||[0,1];
      const pct = (denom && lo && hi) ? (100 * (1 - (Math.min(Math.max(denom,lo),hi)-lo)/(hi-lo))) : 0;
      const row = document.createElement('div'); row.className='bar';
      row.innerHTML = `<div class="name">${d.label}</div>
        <div class="track"><div class="fill" style="width:${pct.toFixed(1)}%"></div></div>
        <div class="val">${denom?('1/'+denom.toFixed(1)):'—'}</div>`;
      root.appendChild(row);
    });
  }

  // ====== UI：尤度表 ======
  function renderLikelihood(save=true){
    const probs = estimateLikelihood(state.metrics||{});
    const root = $('#likelihood');
    root.innerHTML = '';

    if(!probs.length){
      const p = document.createElement('p');
      p.className = 'note';
      p.textContent = '比較に必要な観測値が見つかりません（総Gや「◯◯合算 1/◯」「VS◯◯中はずれ 1/◯」などを貼り付けてください）。';
      root.appendChild(p);
      return;
    }

    const sorted = [...probs].sort((a,b)=>b.p-a.p);
    const table = document.createElement('table');
    table.innerHTML = '<thead><tr><th>設定</th><th>推測％</th></tr></thead><tbody></tbody>';
    sorted.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.setting}</td><td>${(r.p*100).toFixed(1)}%</td>`;
      table.querySelector('tbody').appendChild(tr);
    });
    root.appendChild(table);

    if(save){ saveHistory(sorted); }
  }

  // ====== 履歴 ======
  const LS_KEY = 'tokuripu_history_v3';
  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(_){ return []; } }
  function saveHistory(sorted){
    const hist = loadHistory();
    const top = sorted[0];
    const h = {
      at: new Date().toISOString(),
      machine: currentMachine().name,
      top: { setting: top?.setting ?? null, p: top? Number((top.p*100).toFixed(1)) : null },
      summary: summarizeMetrics(state.metrics||{}),
      raw: state.metrics
    };
    hist.unshift(h);
    localStorage.setItem(LS_KEY, JSON.stringify(hist.slice(0,200)));
    renderHistory();
  }
  function summarizeMetrics(m){
    const f = (x)=> x? ('1/'+Number(x).toFixed(1)) : '—';
    const label = ($('#machine').value==='versus-revise')?'スイカ':'氷';
    return `ベル:${f(m.bell)} / ${label}:${f(m.ice)} / CH:${f(m.cherry)} / HC:${f(m.rt_hc)} / HG:${f(m.rt_hg)}`;
  }
  function renderHistory(){
    const hist = loadHistory();
    $('#hist-count').textContent = `${hist.length} 件`;
    const tbody = document.querySelector('#hist tbody'); tbody.innerHTML = '';
    hist.forEach(h=>{
      const d = new Date(h.at);
      const dt = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${dt}</td><td>${h.machine}</td><td>設定${h.top.setting??'—'}（${h.top.p??'—'}%）</td><td>${h.summary}</td>`;
      tbody.appendChild(tr);
    });
  }
  function exportCSV(){
    const hist = loadHistory();
    const head = ['日時','機種','最有力設定','推測%','ベル(1/◯)','スイカ/氷(1/◯)','チェリー(1/◯)','HC(1/◯)','HG(1/◯)'];
    const rows = hist.map(h=>{
      const m = h.raw||{}; const f = v=> v?Number(v).toFixed(1):'';
      return [h.at,h.machine,h.top?.setting??'',h.top?.p??'', f(m.bell),f(m.ice),f(m.cherry),f(m.rt_hc),f(m.rt_hg)];
    });
    const csv = [head, ...rows].map(r=> r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    downloadText('history.csv', csv);
  }
  function exportJSON(){ const hist = loadHistory(); downloadText('history.json', JSON.stringify(hist,null,2)); }
  function downloadText(name, txt){ const blob = new Blob([txt], {type:'text/plain;charset=utf-8'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href); }

  // ====== イベント配線 ======
  document.getElementById('analyze').addEventListener('click', ()=>{
    state.flags.peace = document.getElementById('peace').checked;
    state.flags.yohakuHazure = document.getElementById('yohaku-hazure').checked;
    state.flags.endRed = document.getElementById('end-red').checked;
    state.flags.rb3xMiss = document.getElementById('rb-3x-miss').checked;

    state.metrics = parseMetricsFromText(document.getElementById('text').value||'');
    renderBars(); renderLikelihood(true);
  });
  document.getElementById('clear').addEventListener('click', ()=>{ document.getElementById('text').value=''; });
  document.getElementById('machine').addEventListener('change', ()=>{
    state.metrics = parseMetricsFromText(document.getElementById('text').value||'');
    renderBars(); renderLikelihood(false);
  });
  document.getElementById('exportCsv').addEventListener('click', exportCSV);
  document.getElementById('exportJson').addEventListener('click', exportJSON);

  // 初期化
  renderHistory();
  </script>
</body>
</html>
