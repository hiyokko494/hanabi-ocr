<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>特リプTV｜新ハナビ：バーサス・リヴァイズ 専用（機種、機能追加中：2025.09.15 Ver.2.0）</title>
  <style>
    :root{--bg:#0b0f14;--card:#121822;--ink:#e7edf6;--muted:#9fb0c6;--accent:#5fd1ff;--good:#ff4d6d;--mid:#4ea8de;--low:#91e5f6;--warn:#ffd166;--ok:#06d6a0}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",Meiryo,sans-serif;}
    header{padding:16px 20px;border-bottom:1px solid #1e2633;background:#0f141d;position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:18px;letter-spacing:.02em}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    main{padding:20px;display:grid;gap:16px;grid-template-columns: 1.1fr .9fr}
    @media (max-width: 960px){main{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid #1b2431;border-radius:14px;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label.kv{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px}
    select,button,input[type="checkbox"],textarea{font:inherit}
    select,button{background:#0f1520;color:var(--ink);border:1px solid #243044;border-radius:10px;padding:8px 10px}
    button.primary{background:linear-gradient(180deg,#1d2a3a,#172233);border-color:#2a3c54}
    button.ghost{background:transparent;border-color:#2a3c54}
    button:active{transform:translateY(1px)}
    textarea#text{width:100%;min-height:180px;background:#0b111a;color:var(--ink);border:1px solid #223045;border-radius:10px;padding:12px}

    .bars{display:grid;gap:10px}
    .bar{display:grid;grid-template-columns: 140px 1fr 90px;gap:10px;align-items:center}
    .bar .name{color:var(--muted);font-size:13px}
    .bar .track{height:12px;background:#0b111a;border:1px solid #213045;border-radius:999px;overflow:hidden}
    .bar .fill{height:100%;background:linear-gradient(90deg,var(--low),var(--mid),var(--good));width:0%}
    .bar .val{font-variant-numeric:tabular-nums;text-align:right;color:#cdd8e8;font-size:13px}

    table{width:100%;border-collapse:collapse;border:1px solid #233046;border-radius:10px;overflow:hidden}
    th,td{border-bottom:1px solid #1e2a3b;padding:8px 10px;font-size:13px}
    th{background:#0f1520;text-align:left;color:#b7c6db}
    tr:last-child td{border-bottom:none}

    .note{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #28405a;border-radius:999px;font-size:12px;color:#a6c3de}
    .hint{font-size:12px;color:#a7bbd5}
    .right{margin-left:auto}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
  </style>
</head>
<body>
  <header>
    <h1>特リプTV｜新ハナビ：バーサス・リヴァイズ 専用（機種、機能追加中：2025.09.15 Ver.2.0）</h1>
    <div class="sub">このファイルをそのままコピペOK。バーサス・リヴァイズを実装済み＋確定系チェックも対応。</div>
  </header>

  <main>
    <section class="card" style="grid-column:1/-1">
      <div class="row">
        <label class="kv">機種：
          <select id="machine">
            <option value="shin-hanabi">新ハナビ</option>
            <option value="versus-revise">バーサス・リヴァイズ</option>
          </select>
        </label>
        <!-- 新ハナビ系（従来） -->
        <label class="kv"><input type="checkbox" id="peace"/> ピース出現（新ハナビ）</label>
        <label class="kv"><input type="checkbox" id="yohaku-hazure"/> 予告音氷ハズレ（新ハナビ）</label>
        <!-- バーサス・リヴァイズ用 確定系 -->
        <label class="kv"><input type="checkbox" id="end-red"/> RB終了画面END赤（設定2以上）</label>
        <label class="kv"><input type="checkbox" id="rb-3x-miss"/> RB中3連Xハズレ（設定5以上）</label>

        <button id="analyze" class="primary">テキストから解析</button>
        <button id="clear" class="ghost">入力をクリア</button>
        <span class="right hint">ユニメモの結果欄をそのまま貼り付け → 「テキストから解析」</span>
      </div>
      <textarea id="text" placeholder="ユニメモの結果テキストをコピペしてください（例：ベル合算 1/◯、VSチャレンジ中はずれ 1/◯、BB中 チェリー＋ベル揃い 1/◯ など）"></textarea>
    </section>

    <section class="card">
      <h3 style="margin-top:0">尤度（設定推測％）</h3>
      <div id="likelihood"></div>
      <div class="note">※ 機種ごとの期待値・重みを用いた簡易尤度。確定系チェックで該当外の設定は自動で0％化。偶奇傾向（BB中複合役など）も加味。</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">抽出メトリクス</h3>
      <div class="bars" id="bars"></div>
    </section>

    <section class="card" style="grid-column:1/-1">
      <div class="row" style="margin-bottom:10px">
        <strong>履歴</strong>
        <span class="pill" id="hist-count">0 件</span>
        <span class="right"></span>
        <button id="exportCsv" class="ghost">CSVエクスポート</button>
        <button id="exportJson" class="ghost">JSONエクスポート</button>
      </div>
      <div class="note">
        ・解析ごとに端末内（localStorage）に保存されます。/ ・重みは後から調整可能です。
      </div>
      <table id="hist">
        <thead><tr><th>日時</th><th>機種</th><th>設定推測</th><th>要約</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
  /* ================= 機種ごとの設定レジストリ ================= */
  const MACHINES = {
    "shin-hanabi": {
      name: "新ハナビ",
      settings: [1,2,5,6],
      expect: {                // 通常時 推定 1/G（分母の逆数）
        bell:  [1/7.7,  1/7.6,  1/7.5,  1/7.3],
        cherry:[1/16.4, 1/15.3, 1/16.1, 1/15.6],
        ice:   [1/51.2, 1/51.8, 1/48.2, 1/49.3],
      },
      expectDenom: {           // BB/RT/RB の分母（目安）
        bb_slant:  {1:11.0, 2:9.0, 5:11.0, 6:9.0},
        bb_rare:   {1:16384,2:16384,5:16384,6:655.4},
        rt_hc_miss:{1:6.0,  2:5.8,  5:5.3,  6:5.1},
        rt_hg_miss:{1:13.4, 2:12.4, 5:10.1, 6:9.5}
      },
      ranges: {                // 解析用の妥当レンジ（画面バー用：分母）
        bell:[4.5,10.5], cherry:[10,25], ice:[35,80],
        bb_slant:[7,13], bb_rare:[400,30000], rt_hc:[4.6,6.6], rt_hg:[8.5,14.5]
      },
      weights: { bell:1.0, cherry:1.0, ice:0.7, bb_slant:1.1, bb_rare:2.2, rt_hc_miss:1.0, rt_hg_miss:1.0 },
      labelRegex: {            // 主ラベル（抽出に使う正規表現）
        bell:/風鈴\s*合算|ベル\s*合算/i,
        cherry:/チェリー\s*合算/i,
        ice:/氷\s*合算/i,
        bb_slant:/(風斜め揃い|斜め風鈴|風鈴B)/i,
        bb_rare:/(レア役|バラケ目)/i,
        rt_hc:/花火チャレンジ中はずれ/i,
        rt_hg:/花火GAME中はずれ/i,
        total:/総ボーナス|総プレイ数|総ゲーム数|総G|プレイ数|ゲーム数/i
      },
      ui: { peaceElId:"peace", yohakuHazureElId:"yohaku-hazure" },
      disableSettingsByFlags: (flags)=>({
        1: flags.peace || flags.yohakuHazure,
        2: flags.yohakuHazure
      }),
      parityAdjust: null // 新ハナビは偶奇補正なし
    },

    /* ===== バーサス・リヴァイズ ===== */
    "versus-revise": {
      name: "バーサス・リヴァイズ",
      settings: [1,2,5,6],
      // 通常時（1/G）：提供値ベース
      expect: {
        bell:  [1/7.2, 1/7.1, 1/6.9, 1/6.8],   // 合算
        cherry:[1/38.2,1/38.9,1/36.7,1/37.3],  // 合算（差は小）
        suika: [1/55.5,1/53.4,1/54.4,1/52.3],  // 合算
        bellA: [1/10.9,1/10.7,1/10.5,1/10.2],
        bellB: [1/20.9,1/21.2,1/20.3,1/20.6],
        suiA:  [1/74.5,1/70.6,1/72.5,1/68.8],
        suiB:  [1/218.5,1/218.5,1/218.5,1/218.5], // 全設定共通
      },
      // 分母系（1/◯）：BB/RT など
      expectDenom: {
        // RT はずれ
        rt_vsc_miss: {1:5.0, 2:4.9, 5:4.6, 6:4.5},   // VS CHANCE
        rt_vsg_miss: {1:10.1,2:9.4, 5:8.7, 6:8.1},   // VS GAME（差が大きい）
        // BIG 中
        bb_bell:     {1:1.10,2:1.14,5:1.10,6:1.14},  // 参考（奇数>偶数）
        bb_cb:       {1:11.1,2:8.9, 5:11.1,6:8.9},   // チェリー＋ベル揃い（偶数優遇）
        bb_cb_miss:  {1:256.0,2:128.0,5:256.0,6:128.0}, // チェリー＋ベルはずれ（偶数強）
      },
      // バー表示用レンジ（分母）
      ranges: {
        bell:[6.2,9.2], cherry:[30,50], suika:[45,80],
        bellA:[9.0,12.5], bellB:[17.0,25.0], suiA:[60,90], suiB:[150,300],
        rt_vsc:[4.2,5.6], rt_vsg:[7.5,10.8],
        bb_cb:[7.5,13.0], bb_cb_miss:[80,350], bb_bell:[1.05,1.20]
      },
      // 重み：新ハナビ基準＋RT/BB偶奇要素をやや強め
      weights: {
        bell:0.9, cherry:0.5, suika:0.8, bellA:1.0, suiA:0.8, // 通常時
        rt_vsc_miss:1.1, rt_vsg_miss:1.6,                     // RT はずれ（GAME強）
        bb_cb:1.2, bb_cb_miss:1.6, bb_bell:0.4                // BB 偶奇示唆
      },
      // ラベル抽出（ユニメモ表記ゆれ対応）
      labelRegex: {
        total:/総ボーナス|総プレイ数|総ゲーム数|総G|プレイ数|ゲーム数/i,
        // 通常時 合算／内訳
        bell:/ベル\s*合算/i,
        bellA:/ベルA/i,
        bellB:/ベルB/i,
        suika:/スイカ\s*合算/i,
        suiA:/スイカA/i,
        suiB:/スイカB/i,
        cherry:/チェリー\s*合算/i,
        // RT中
        rt_vsc:/VS?\s*チャレンジ中はずれ|VS\s*CHANCE中はずれ/i,
        rt_vsg:/VS?\s*GAME中はずれ/i,
        // BB中（予告音時の複合役などの表示想定）
        bb_bell:/BB中[\s\S]*?ベル\b|\bベル\s*1\/|^\s*ベル\s*$/i,
        bb_cb:/チェリー\s*\+\s*ベル揃い|チェリー\+ベル揃い/i,
        bb_cb_miss:/チェリー\s*\+\s*ベルはずれ|チェリー\+ベルはずれ/i
      },
      ui: { endRedElId:"end-red", rb3xMissElId:"rb-3x-miss" },
      disableSettingsByFlags: (flags)=>({
        1: !!flags.endRed || !!flags.rb3xMiss, // END赤または3連X→設定1除外
        2: !!flags.rb3xMiss,                   // 3連X→設定2も除外（5以上確定）
      }),
      // 偶奇補正：BB中の複合役・はずれの観測から Even(2/6) を強化
      parityAdjust: function(obs){
        const evenSig = scoreRatioBetter(obs.bb_cb, 1/8.9, 1/11.1) + scoreRatioBetter(obs.bb_cb_miss, 1/128.0, 1/256.0);
        const k = Math.min(1.6, 1.0 + evenSig*0.6); // 0→1.0, 強い偶数傾向→最大1.6倍
        return {even:k, odd:1/(k**0.9)};            // 奇数は少し抑える（過剰抑制防止）
      }
    }
  };

  // ============== 共通 State / Utils ==============
  const state = { metrics:{}, flags:{ peace:false, yohakuHazure:false, endRed:false, rb3xMiss:false } };
  const $ = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const currentMachine = ()=> MACHINES[$('#machine').value || 'shin-hanabi'];

  // ====== 解析：ユニメモテキストから数値を抽出 ======
  function parseMetricsFromText(txt){
    const M = currentMachine();
    const R = M.labelRegex||{};
    const metrics = {};

    const guessTotalGames = (t)=>{
      const m = t.match(/(総プレイ数|総ゲーム数|総G|プレイ数|ゲーム数)[^\d]*(\d{1,3}(?:,\d{3})*|\d+)\s*G/i);
      if(!m) return 0; return parseInt(m[2].replace(/,/g,''),10);
    };
    const totalG = guessTotalGames(txt); metrics.totalG = totalG||0;

    const pickDenomNear = (regex)=>{
      if(!regex) return null; const m = txt.match(regex); if(!m) return null;
      const tail = txt.slice(m.index).slice(0, 70);
      const m1 = tail.match(/1\s*\/(\d+\.?\d*)/); if(m1) return parseFloat(m1[1]);
      const m2 = tail.match(/(\d+\.?\d*)\s*回/); if(m2 && totalG>0){ const cnt=parseFloat(m2[1]); return totalG/cnt; }
      return null;
    };

    // 共通系
    metrics.bell   = pickDenomNear(R.bell);
    metrics.cherry = pickDenomNear(R.cherry);
    metrics.ice    = pickDenomNear(R.ice); // 新ハナビのみ

    // バーサス通常時内訳
    metrics.bellA  = pickDenomNear(R.bellA);
    metrics.bellB  = pickDenomNear(R.bellB);
    metrics.suika  = pickDenomNear(R.suika);
    metrics.suiA   = pickDenomNear(R.suiA);
    metrics.suiB   = pickDenomNear(R.suiB);

    // RT
    metrics.rt_hc  = pickDenomNear(R.rt_hc) || pickDenomNear(R.rt_vsc);
    metrics.rt_hg  = pickDenomNear(R.rt_hg) || pickDenomNear(R.rt_vsg);

    // BB（バーサス）
    metrics.bb_bell    = pickDenomNear(R.bb_bell);
    metrics.bb_cb      = pickDenomNear(R.bb_cb);
    metrics.bb_cb_miss = pickDenomNear(R.bb_cb_miss);

    return metrics;
  }

  // ====== 推測：簡易尤度計算（＋偶奇補正） ======
  function estimateLikelihood(metrics){
    const M = currentMachine();
    const settings = M.settings;
    const weights = M.weights || {};
    const exp = M.expect || {};
    const denom = M.expectDenom || {};

    const FLAGS_DISABLE = M.disableSettingsByFlags ? M.disableSettingsByFlags(state.flags) : {};

    const asRate = v=> (v && v>0) ? (1/parseFloat(v)) : null;
    const obs = {
      // 新ハナビ
      bell:   asRate(metrics.bell),
      cherry: asRate(metrics.cherry),
      ice:    asRate(metrics.ice),
      rt_hc_miss: metrics.rt_hc ? (1/metrics.rt_hc) : null,
      rt_hg_miss: metrics.rt_hg ? (1/metrics.rt_hg) : null,
      // バーサス
      bellA: asRate(metrics.bellA), bellB: asRate(metrics.bellB),
      suika: asRate(metrics.suika), suiA: asRate(metrics.suiA), suiB: asRate(metrics.suiB),
      rt_vsc_miss: metrics.rt_hc ? (1/metrics.rt_hc) : null,
      rt_vsg_miss: metrics.rt_hg ? (1/metrics.rt_hg) : null,
      bb_bell: metrics.bb_bell? (1/metrics.bb_bell): null,
      bb_cb:   metrics.bb_cb? (1/metrics.bb_cb): null,
      bb_cb_miss: metrics.bb_cb_miss? (1/metrics.bb_cb_miss): null,
    };

    const scoreFor = (expected, observed)=>{
      if(expected==null || observed==null) return null;
      const rel = Math.abs(observed-expected)/Math.max(expected,1e-9);
      return Math.exp(- (rel*rel) / (2*0.12*0.12));
    };

    const raw = settings.map((s)=>{
      if(FLAGS_DISABLE[s]) return {setting:s, score:-Infinity};
      const idx = [1,2,5,6].indexOf(s);
      let sum=0, w=0;

      // --- 新ハナビ or 共通（あれば使う）
      if(exp.bell && obs.bell!=null){ sum += (weights.bell||1)*scoreFor(exp.bell[idx], obs.bell); w += (weights.bell||1); }
      if(exp.cherry && obs.cherry!=null){ sum += (weights.cherry||1)*scoreFor(exp.cherry[idx], obs.cherry); w += (weights.cherry||1); }
      if(exp.ice && obs.ice!=null){ sum += (weights.ice||1)*scoreFor(exp.ice[idx], obs.ice); w += (weights.ice||1); }

      // --- バーサス（通常時内訳）
      if(exp.bellA && obs.bellA!=null){ sum += (weights.bellA||0)*scoreFor(exp.bellA[idx], obs.bellA); w += (weights.bellA||0); }
      if(exp.suika && obs.suika!=null){ sum += (weights.suika||0)*scoreFor(exp.suika[idx], obs.suika); w += (weights.suika||0); }
      if(exp.suiA && obs.suiA!=null){ sum += (weights.suiA||0)*scoreFor(exp.suiA[idx], obs.suiA); w += (weights.suiA||0); }

      // --- RT / BB（分母→逆数で期待）
      if(denom.rt_vsc_miss && obs.rt_vsc_miss!=null){ sum += (weights.rt_vsc_miss||0)*scoreFor(1/denom.rt_vsc_miss[s], obs.rt_vsc_miss); w+=(weights.rt_vsc_miss||0); }
      if(denom.rt_vsg_miss && obs.rt_vsg_miss!=null){ sum += (weights.rt_vsg_miss||0)*scoreFor(1/denom.rt_vsg_miss[s], obs.rt_vsg_miss); w+=(weights.rt_vsg_miss||0); }
      if(denom.bb_cb && obs.bb_cb!=null){ sum += (weights.bb_cb||0)*scoreFor(1/denom.bb_cb[s], obs.bb_cb); w+=(weights.bb_cb||0); }
      if(denom.bb_cb_miss && obs.bb_cb_miss!=null){ sum += (weights.bb_cb_miss||0)*scoreFor(1/denom.bb_cb_miss[s], obs.bb_cb_miss); w+=(weights.bb_cb_miss||0); }
      if(denom.bb_bell && obs.bb_bell!=null){ sum += (weights.bb_bell||0)*scoreFor(1/denom.bb_bell[s], obs.bb_bell); w+=(weights.bb_bell||0); }

      return {setting:s, score: w>0 ? (sum/w) : 0.0001};
    });

    // 正規化
    let scores = raw.map(r=> ({setting:r.setting, v: Math.max(0, r.score)}));

    // 偶奇補正（バーサスのみ）
    if(currentMachine().parityAdjust){
      const pf = currentMachine().parityAdjust(obs); // {even, odd}
      scores = scores.map(o=>{
        const isEven = (o.setting===2 || o.setting===6);
        return {setting:o.setting, v: o.v * (isEven? pf.even : pf.odd)};
      });
    }

    // 0%化された設定（-Infinity）に対応
    scores = scores.map(o=> ({...o, v: (FLAGS_DISABLE[o.setting] ? 0 : o.v)}));

    const total = scores.reduce((a,b)=>a+b.v,0) || 1;
    return scores.map(o=> ({setting:o.setting, p:o.v/total}));
  }

  // 偶奇スコア補助：観測値が evenExp に近く oddExp よりも近ければ正の寄与
  function scoreRatioBetter(observed, evenExp, oddExp){
    if(observed==null) return 0;
    const de = Math.abs(observed - (1/evenExp));
    const doo = Math.abs(observed - (1/oddExp));
    const gain = (doo - de) / Math.max(1/evenExp,1/oddExp);
    return Math.max(0, gain*3); // 強すぎないよう係数調整
  }

  // ====== UI：バー描画・尤度表 ======
  function renderBars(){
    const M = currentMachine();
    const R = M.ranges || {};
    const m = state.metrics || {};
    const root = $('#bars');
    root.innerHTML = '';

    const defs = [];
    if(M.name.includes('ハナビ')){
      defs.push(
        {key:'bell',    label:'風鈴（1/◯）', range:R.bell},
        {key:'cherry',  label:'チェリー（1/◯）', range:R.cherry},
        {key:'ice',     label:'氷（1/◯）', range:R.ice},
        {key:'rt_hc',   label:'HC はずれ（1/◯）', range:R.rt_hc},
        {key:'rt_hg',   label:'HG はずれ（1/◯）', range:R.rt_hg}
      );
    } else {
      defs.push(
        {key:'bell',    label:'ベル合算（1/◯）', range:R.bell},
        {key:'suika',   label:'スイカ合算（1/◯）', range:R.suika},
        {key:'cherry',  label:'チェリー合算（1/◯）', range:R.cherry},
        {key:'bellA',   label:'ベルA（1/◯）', range:R.bellA},
        {key:'suiA',    label:'スイカA（1/◯）', range:R.suiA},
        {key:'suiB',    label:'スイカB（1/◯）', range:R.suiB},
        {key:'rt_hc',   label:'VS CHANCE はずれ（1/◯）', range:R.rt_vsc},
        {key:'rt_hg',   label:'VS GAME はずれ（1/◯）', range:R.rt_vsg},
        {key:'bb_cb',   label:'BB 複合（チェリー+ベル揃い）（1/◯）', range:R.bb_cb},
        {key:'bb_cb_miss',label:'BB 複合はずれ（1/◯）', range:R.bb_cb_miss}
      );
    }

    defs.forEach(d=>{
      const val = m[d.key];
      const [lo,hi] = d.range || [0,1];
      const denom = Number(val||0);
      const pct = (denom && lo && hi) ? (100 * (1 - (Math.min(Math.max(denom,lo),hi)-lo)/(hi-lo))) : 0; // 分母が小さいほど良い
      const row = document.createElement('div'); row.className='bar';
      row.innerHTML = `<div class="name">${d.label}</div>
        <div class="track"><div class="fill" style="width:${pct.toFixed(1)}%"></div></div>
        <div class="val">${denom?('1/'+denom.toFixed(1)):'—'}</div>`;
      root.appendChild(row);
    });
  }

  function renderLikelihood(save=true){
    const probs = estimateLikelihood(state.metrics||{});
    const root = $('#likelihood');
    root.innerHTML = '';

    const sorted = [...probs].sort((a,b)=>b.p-a.p);
    const table = document.createElement('table');
    table.innerHTML = '<thead><tr><th>設定</th><th>推測％</th></tr></thead><tbody></tbody>';
    sorted.forEach(r=>{
      const tr = document.createElement('tr');
      const pct = (r.p*100);
      tr.innerHTML = `<td>${r.setting}</td><td>${pct.toFixed(1)}%</td>`;
      table.querySelector('tbody').appendChild(tr);
    });
    root.appendChild(table);

    if(save){ saveHistory(sorted); }
  }

  // ====== 履歴 ======
  const LS_KEY = 'tokuripu_history_v3';
  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(_){ return []; } }
  function saveHistory(sorted){
    const hist = loadHistory();
    const top = sorted[0];
    const h = {
      at: new Date().toISOString(),
      machine: currentMachine().name,
      top: { setting: top?.setting ?? null, p: top? Number((top.p*100).toFixed(1)) : null },
      summary: summarizeMetrics(state.metrics||{}),
      raw: state.metrics
    };
    hist.unshift(h);
    localStorage.setItem(LS_KEY, JSON.stringify(hist.slice(0,200)));
    renderHistory();
  }
  function summarizeMetrics(m){
    const f = (x)=> x? ('1/'+Number(x).toFixed(1)) : '—';
    return `ベル:${f(m.bell)} / スイカ:${f(m.suika||m.ice)} / CH:${f(m.cherry)} / HC:${f(m.rt_hc)} / HG:${f(m.rt_hg)}`;
  }
  function renderHistory(){
    const hist = loadHistory();
    $('#hist-count').textContent = `${hist.length} 件`;
    const tbody = $('#hist tbody'); tbody.innerHTML = '';
    hist.forEach(h=>{
      const d = new Date(h.at);
      const dt = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${dt}</td><td>${h.machine}</td><td>設定${h.top.setting??'—'}（${h.top.p??'—'}%）</td><td>${h.summary}</td>`;
      tbody.appendChild(tr);
    });
  }
  function exportCSV(){
    const hist = loadHistory();
    const head = ['日時','機種','最有力設定','推測%','ベル(1/◯)','スイカ(1/◯)','チェリー(1/◯)','HC(1/◯)','HG(1/◯)'];
    const rows = hist.map(h=>{
      const m = h.raw||{}; const f = v=> v?Number(v).toFixed(1):'';
      return [h.at,h.machine,h.top?.setting??'',h.top?.p??'', f(m.bell),f(m.suika||m.ice),f(m.cherry),f(m.rt_hc),f(m.rt_hg)];
    });
    const csv = [head, ...rows].map(r=> r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    downloadText('history.csv', csv);
  }
  function exportJSON(){ const hist = loadHistory(); downloadText('history.json', JSON.stringify(hist,null,2)); }
  function downloadText(name, txt){ const blob = new Blob([txt], {type:'text/plain;charset=utf-8'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href); }

  // ====== イベント配線 ======
  $('#analyze').addEventListener('click', ()=>{
    state.flags.peace = $('#peace').checked;
    state.flags.yohakuHazure = $('#yohaku-hazure').checked;
    state.flags.endRed = $('#end-red').checked;
    state.flags.rb3xMiss = $('#rb-3x-miss').checked;
    state.metrics = parseMetricsFromText($('#text').value||'');
    renderBars(); renderLikelihood(true);
  });
  $('#clear').addEventListener('click', ()=>{ $('#text').value=''; });
  $('#machine').addEventListener('change', ()=>{
    state.metrics = parseMetricsFromText($('#text').value||'');
    renderBars(); renderLikelihood(false);
  });
  $('#exportCsv').addEventListener('click', exportCSV);
  $('#exportJson').addEventListener('click', exportJSON);

  // 初期化
  renderHistory();
  </script>
</body>
</html>
