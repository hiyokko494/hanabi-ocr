<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>新ハナビ｜設定推測（ローカルOCR対応・デモ）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
           margin: 24px; color: #111; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .hint { background: #fff7ed; border: 1px solid #fed7aa; color: #7c2d12; padding: 8px 10px; border-radius: 8px; font-size: 13px; }
    .error { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; padding: 8px 10px; border-radius: 8px; font-size: 13px; margin-top: 8px; }
    .row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-top: 12px; }
    .btn { font-size: 13px; padding: 6px 10px; border-radius: 6px; border: 0; cursor: pointer; }
    .btn.primary { background: #111; color: #fff; }
    .btn.disabled { background: #d1d5db; color: #6b7280; cursor: not-allowed; }
    img.thumb { height: 112px; border: 1px solid #e5e7eb; border-radius: 8px; }
    .card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; margin-top: 12px; }
    .card h3 { margin: 0 0 8px; font-size: 14px; }
    textarea { width: 100%; height: 120px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    @media (min-width: 640px) { .grid { grid-template-columns: 1fr 1fr; } }
    label span.key { width: 72px; color: #6b7280; display: inline-block; }
    input[type="number"] { border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px 8px; width: 100%; }
    .perg { font-size: 11px; color: #6b7280; width: 80px; text-align: right; }
    .bar-wrap { width: 100%; height: 16px; background: #e5e7eb; border-radius: 999px; overflow: hidden; }
    .bar { height: 16px; transition: width 300ms ease; }
    .rowline { display: flex; align-items: center; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
    .footer { margin-top: 16px; font-size: 12px; color: #6b7280; }
    code { background: #f3f4f6; padding: 0 4px; border-radius: 4px; }
  </style>
  <!-- ★ 追加：先にライブラリを読み込む（相対パス） -->
<script src="tesseract/tesseract.min.js" defer></script>
</head>
<body>
  <h1>新ハナビ｜設定推測（ローカルOCR対応・デモ）</h1>
  <div class="hint">
    <strong>使い方:</strong> スクショを選んで「画像から解析」。失敗や未準備なら、下のテキスト欄に貼り付けて「テキストから解析」を押してください。<br/>
    Option B（ローカル同梱）で使う場合は、<code>tesseract/</code> フォルダに必要ファイルを置いてから再読み込みしてください。
  </div>

  <div id="err" class="error" style="display:none"></div>

  <div class="row">
    <input id="file" type="file" accept="image/*" />
    <img id="thumb" class="thumb" style="display:none" alt="preview"/>
    <button id="btn-ocr" class="btn primary disabled" disabled>画像から解析</button>
  </div>

  <div class="card">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h3>テキスト（手動貼り付け）</h3>
      <button id="btn-parse" class="btn" style="background:#2563eb; color:#fff;">テキストから解析</button>
    </div>
    <textarea id="text" placeholder="例)
総プレイ数 6,056G
風鈴合算 813回 1/7.4
チェリー合算 381回 1/15.9
氷合算 103回 1/58.8"></textarea>
  </div>

  <div class="card">
    <h3>抽出メトリクス（編集可）</h3>
    <div class="grid" id="metrics"></div>
  </div>

  <div class="card">
    <h3>推測比較（最大=赤、最小=水色）</h3>
    <div id="bars">必要な数値が揃うと比較グラフが表示されます。</div>
  </div>

  <div class="footer">
    ローカルOCR：<code>tesseract/</code> に <code>worker.min.js</code>, <code>tesseract-core.wasm.js</code>, <code>lang-data/jpn.traineddata.gz</code>, <code>lang-data/eng.traineddata.gz</code> を配置。
  </div>

<script>
const PRESETS = {
  "新ハナビ": {
    bell: [1/7.7, 1/7.6, 1/7.5, 1/7.3],
    cherry: [1/16.4, 1/15.3, 1/16.1, 1/15.6],
    ice: [1/51.2, 1/51.8, 1/48.2, 1/49.3],
  },
};

const state = {
  imgUrl: null,
  ocrText: "",
  metrics: { games: undefined, bell: undefined, cherry: undefined, ice: undefined },
};

function sanitize(s) {
  return s
    .replace(/[０-９]/g, (d) => String.fromCharCode(d.charCodeAt(0) - 0xFEE0))
    .replace(/[，]/g, ",")
    .replace(/[．]/g, ".")
    .replace(/[　]/g, " ");
}

function parseMetricsFromText(text) {
  const lines = sanitize(text).split(/\r?\n/);
  const getCount = (re) => {
    const line = lines.find((l) => re.test(l));
    if (!line) return undefined;
    const m = line.match(/([0-9]{1,3}(?:,[0-9]{3})*|[0-9]+)/);
    return m ? Number(m[1].replace(/,/g, "")) : undefined;
  };
  return {
    games: getCount(/総[ププ]レイ|総ゲーム|総プレイ数|ゲーム数|回転数/i),
    bell: getCount(/風鈴合算|風鈴\s*合算/i),
    cherry: getCount(/チェリー合算|チェリー\s*合算/i),
    ice: getCount(/氷合算|氷\s*合算/i),
  };
}

function estimateAllSettings(metrics) {
  const g = metrics.games || 0;
  if (!g) return [];
  const perG = {
    bell: (metrics.bell || 0) / g,
    cherry: (metrics.cherry || 0) / g,
    ice: (metrics.ice || 0) / g,
  };
  const core = PRESETS["新ハナビ"];
  const base = [1,2,5,6];
  const rows = base.map((setting, idx) => {
    const err = Math.pow(perG.bell - core.bell[idx],2)
              + Math.pow(perG.cherry - core.cherry[idx],2)
              + Math.pow(perG.ice - core.ice[idx],2);
    const score = 1/(1+err);
    return { setting, err, score, percent: 0 };
  });
  const sum = rows.reduce((a,b)=>a+b.score,0) || 1;
  rows.forEach(r => r.percent = (r.score/sum)*100);
  return rows;
}

function barColor(p, maxP, minP) {
  if (p === maxP) return "rgba(239,68,68,0.85)";
  if (p === minP) return "rgba(147,197,253,0.85)";
  const t = (p - minP) / Math.max(1, maxP - minP);
  const from = { r:147, g:197, b:253 };
  const to   = { r:59,  g:130, b:246 };
  const r = Math.round(from.r + (to.r - from.r)*t);
  const g = Math.round(from.g + (to.g - from.g)*t);
  const b = Math.round(from.b + (to.b - from.b)*t);
  return `rgba(${r},${g},${b},0.9)`;
}

function renderMetrics() {
  const wrap = document.getElementById("metrics");
  wrap.innerHTML = "";
  const keys = ["games", "bell", "cherry", "ice"];
  keys.forEach((k) => {
    const row = document.createElement("label");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.gap = "8px";

    const keySpan = document.createElement("span");
    keySpan.className = "key";
    keySpan.textContent = k;
    row.appendChild(keySpan);

    const input = document.createElement("input");
    input.type = "number";
    input.value = state.metrics[k] ?? "";
    input.oninput = (e)=>{
      const v = e.target.value === "" ? undefined : Number(e.target.value);
      state.metrics[k] = v;
      renderBars();
      renderMetrics(); // update /G helper
    };
    row.appendChild(input);

    const tail = document.createElement("span");
    tail.className = "perg";
    if (k !== "games" && state.metrics.games) {
      const val = ( (state.metrics[k] || 0) / (state.metrics.games || 1) ).toFixed(4);
      tail.textContent = "/G " + val;
    } else {
      tail.textContent = "";
    }
    row.appendChild(tail);

    wrap.appendChild(row);
  });
}

function renderBars() {
  const mount = document.getElementById("bars");
  const rows = estimateAllSettings(state.metrics);
  if (!rows.length) {
    mount.textContent = "必要な数値が揃うと比較グラフが表示されます。";
    return;
  }
  const perc = rows.map(r=>r.percent);
  const maxP = Math.max(...perc);
  const minP = Math.min(...perc);
  mount.innerHTML = "";
  rows.forEach((r)=>{
    const head = document.createElement("div");
    head.className = "rowline";
    head.innerHTML = `<span class="label">設定${r.setting}</span><span>${r.percent.toFixed(2)}%</span>`;
    const barWrap = document.createElement("div");
    barWrap.className = "bar-wrap";
    const bar = document.createElement("div");
    bar.className = "bar";
    bar.style.width = Math.max(0, Math.min(100, r.percent)) + "%";
    bar.style.background = barColor(r.percent, maxP, minP);
    barWrap.appendChild(bar);
    mount.appendChild(head);
    mount.appendChild(barWrap);
  });
}

function setError(msg) {
  const box = document.getElementById("err");
  if (!msg) { box.style.display = "none"; box.textContent = ""; return; }
  box.style.display = "block"; box.textContent = msg;
}

function init() {
  try {
    const sample = "総プレイ数 6,000G\n風鈴合算 780回\nチェリー合算 380回\n氷合算 110回";
    const m = parseMetricsFromText(sample);
    console.assert(m.games===6000 && m.bell===780 && m.cherry===380 && m.ice===110, "parse ok");
  } catch {}

  renderMetrics();
  renderBars();

  const file = document.getElementById("file");
  const thumb = document.getElementById("thumb");
  const btnOcr = document.getElementById("btn-ocr");
  const btnParse = document.getElementById("btn-parse");
  const text = document.getElementById("text");

  file.addEventListener("change", (e)=>{
    setError("");
    const f = e.target.files && e.target.files[0];
    if (!f) { thumb.style.display="none"; state.imgUrl=null; btnOcr.classList.add("disabled"); btnOcr.disabled=true; return; }
    const url = URL.createObjectURL(f);
    state.imgUrl = url;
    thumb.src = url; thumb.style.display = "inline-block";
    btnOcr.classList.remove("disabled"); btnOcr.disabled = false;
  });

  btnOcr.addEventListener("click", async ()=>{
    if (!state.imgUrl) return;
    setError("");
    btnOcr.textContent = "OCR解析中...";
    btnOcr.disabled = true;
    try {
      const { createWorker } = window.Tesseract || {};
      if (!createWorker) throw new Error("Tesseract not loaded");
      const worker = await createWorker({
        workerPath: "tesseract/worker.min.js",
        corePath: "tesseract/tesseract-core.wasm.js",
        langPath: "tesseract/lang-data",
        logger: ()=>{},
      });
      await worker.loadLanguage("jpn+eng");
      await worker.initialize("jpn+eng");
      const { data } = await worker.recognize(state.imgUrl);
      await worker.terminate();
      const t = (data && data.text) || "";
      state.ocrText = t;
      text.value = t;
      state.metrics = parseMetricsFromText(t);
      renderMetrics();
      renderBars();
    } catch (e) {
      setError("OCRが使用できません。tesseract/ に必要ファイルを配置するか、テキストを貼り付けて「テキストから解析」を使ってください。");
    } finally {
      btnOcr.textContent = "画像から解析";
      btnOcr.disabled = false;
    }
  });

  btnParse.addEventListener("click", ()=>{
    setError("");
    state.ocrText = text.value || "";
    state.metrics = parseMetricsFromText(state.ocrText);
    renderMetrics();
    renderBars();
  });
}

init();
</script>
</body>
</html>
